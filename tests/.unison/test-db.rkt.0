#lang racket
(require towers-lib/preferences
         towers-lib/connection
         towers-lib/base ; required to read the preferences
         (only-in towers-server/db 
                  set-auto-connection 
                  get-connection
                  )
         db)

(set-pref 'database #f)
(set-auto-connection)
(define cnx (get-connection))

;; Execute all statements in the file
;;HACK! The file must not contain ";" other than for query separation!
;; This creates a new database and fills it with some values
(for ([str (string-split (file->string "db.sql") ";")])
  (define q (string-trim str))
  (unless (equal? q "")
    ;(displayln "executing query:")
    ;(write q)(newline)
    (query cnx q)))

; Correct the database value
; and the connection
(set-pref 'database (query-value cnx "select database()"))
(set-auto-connection)
(set! cnx (get-connection))

(module+ test
  (require rackunit)
  
  (displayln "Starting server.")
  (thread (Î»()(dynamic-require 'towers-server/server #f)))
          
  (sleep 3)
  (displayln "Server started.")
  
  (set-login-password "plip" "plop")
  (check-authentication)
  ; create user plop with pwd plip
  (create-user "plap" "plup" "plap@plup.com")
  ; duplicate identifier test
  (create-user "plap" "plup" "plap@plup.com")
  )
