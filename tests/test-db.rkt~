#lang racket
(require towers-lib/preferences
         towers-lib/connection
         towers-lib/base
         (only-in towers-server/db 
                  set-auto-connection 
                  get-connection
                  )
         db)

#;(define cnx
  (mysql-connect #:user (get-pref 'mysql-user)
                 #:password (get-pref 'mysql-password)))

(set-pref 'database #f)
(set-auto-connection)
(define cnx (get-connection))

;; Execute all statements in the file
;;HACK! The file must not contain ";" other than for query separation!
(for ([str (string-split (file->string "db.sql") ";")])
  (define q (string-trim str))
  (unless (equal? q "")
    (displayln "executing query:")
    (write q)(newline)
    (query cnx q)))

; Correct the database value
(set-pref 'database (query-value cnx "select database()"))

(module+ test
  (require rackunit)
  
  (thread (Î»()(dynamic-require 'towers-server/server #f)))
          
  (sleep 3)
  (displayln "server started")
  
  (set-login-password "plip" "plop")
  (check-authentication)
  )
